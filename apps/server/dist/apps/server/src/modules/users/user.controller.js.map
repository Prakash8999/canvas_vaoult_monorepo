{
  "version": 3,
  "sources": ["../../../../../../src/modules/users/user.controller.ts"],
  "sourcesContent": ["import { Request, Response } from 'express';\r\nimport User, { CreateUserSchema, UserLoginSchema, UserOtpVerifySchema, ForgotPasswordSchema, ResetPasswordWithOtpSchema, ResetPasswordWithTokenSchema, UpdateUserSchema } from './users.model';\r\nimport { successHandler, errorHandler } from '../../common/middlewares/responseHandler';\r\nimport { parseError } from '../../common/utils/error.parser';\r\nimport * as userService from './user.service';\r\nimport { clearRefreshTokenCookie, findValidRefreshSession, generateAccessToken, revokeRefreshSession, rotateRefreshToken, setRefreshTokenCookie } from '../../common/utils/authTokenService';\r\nimport redisClient from '../../config/redis';\r\nimport { redisKey } from '../../common/utils/redisKey';\r\nimport { v4 } from 'uuid';\r\n\r\n\r\nexport const addUser = async (req: Request, res: Response) => {\r\n\ttry {\r\n\r\n\t\tconst body = CreateUserSchema.parse(req.body);\r\n\t\tconst { user, otp } = await userService.createUserService(body);\r\n\t\tsuccessHandler(res, 'User created successfully', { id: user.dataValues.id, otp }, 201);\r\n\t} catch (error) {\r\n\t\tconsole.log(error);\r\n\t\tconst errorParser = parseError(error);\r\n\t\terrorHandler(res, \"Failed to create user\", errorParser.message, errorParser.statusCode);\r\n\t}\r\n}\r\n\r\n\r\n\r\n\r\nexport const verifyOtp = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tconst body = UserOtpVerifySchema.parse(req.body);\r\n\t\tconst { token } = await userService.verifyOtpService(body.email, body.otp, req, res);\r\n\t\tsuccessHandler(res, 'Email verified successfully', { token }, 200);\r\n\t} catch (error) {\r\n\t\tconst errorParser = parseError(error);\r\n\t\terrorHandler(res, \"Failed to verify email\", errorParser.message, errorParser.statusCode);\r\n\t}\r\n}\r\n\r\n\r\nexport const loginUser = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tconsole.log(req.body);\r\n\t\tconst body = UserLoginSchema.parse(req.body);\r\n\t\tconst { token } = await userService.loginUserService(body.email, body.password, req, res);\r\n\t\tsuccessHandler(res, 'Login successful', { token }, 200);\r\n\t} catch (error) {\r\n\t\tconsole.log(error);\r\n\t\tconst errorParser = parseError(error);\r\n\t\terrorHandler(res, \"Failed to login\", errorParser.message, errorParser.statusCode);\r\n\t}\r\n}\r\n\r\n\r\nexport const getUserProfile = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tif (!req.user) {\r\n\t\t\terrorHandler(res, 'Unauthorized', {}, 401);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst userId = Number(req.user.userId);\r\n\t\tif (Number.isNaN(userId)) {\r\n\t\t\terrorHandler(res, 'Invalid user id', {}, 400);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst user = await userService.getUserProfileService(userId);\r\n\t\tsuccessHandler(res, 'User profile fetched successfully', user, 200);\r\n\t} catch (error) {\r\n\t\tconst errorParser = parseError(error);\r\n\t\terrorHandler(res, \"Failed to fetch user profile\", errorParser.message, errorParser.statusCode);\r\n\t}\r\n}\r\n\r\nexport const updateUserProfile = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tif (!req.user) {\r\n\t\t\terrorHandler(res, 'Unauthorized', {}, 401);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst userId = Number(req.user.userId);\r\n\t\tif (Number.isNaN(userId)) {\r\n\t\t\terrorHandler(res, 'Invalid user id', {}, 400);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst body = UpdateUserSchema.parse(req.body);\r\n\t\tawait userService.updateUserProfileService(userId, body as any);\r\n\t\tsuccessHandler(res, 'User profile updated successfully', {}, 200);\r\n\t} catch (error) {\r\n\t\tconst errorParser = parseError(error);\r\n\t\terrorHandler(res, \"Failed to update user profile\", errorParser.message, errorParser.statusCode);\r\n\t}\r\n}\r\n\r\nexport const blockUser = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tif (!req.user) {\r\n\t\t\terrorHandler(res, 'Unauthorized', {}, 401);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst userId = Number(req.user.userId);\r\n\t\tif (Number.isNaN(userId)) {\r\n\t\t\terrorHandler(res, 'Invalid user id', {}, 400);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tawait userService.blockUserService(userId);\r\n\t\tsuccessHandler(res, 'User blocked successfully', {}, 200);\r\n\t} catch (error) {\r\n\t\tconst errorParser = parseError(error);\r\n\t\terrorHandler(res, \"Failed to block user\", errorParser.message, errorParser.statusCode);\r\n\t}\r\n}\r\n\r\nexport const forgotPasswordOtp = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tconst body = ForgotPasswordSchema.parse(req.body);\r\n\t\tconst result = await userService.forgotPasswordOtpService(body.email);\r\n\t\tsuccessHandler(res, result.message, {}, 200);\r\n\t} catch (error) {\r\n\t\tconst errorParser = parseError(error);\r\n\t\terrorHandler(res, \"Failed to send password reset OTP\", errorParser.message, errorParser.statusCode);\r\n\t}\r\n}\r\n\r\nexport const forgotPasswordLink = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tconst body = ForgotPasswordSchema.parse(req.body);\r\n\t\tconst result = await userService.forgotPasswordLinkService(body.email);\r\n\t\tsuccessHandler(res, result.message, {}, 200);\r\n\t} catch (error) {\r\n\t\tconst errorParser = parseError(error);\r\n\t\terrorHandler(res, \"Failed to send password reset link\", errorParser.message, errorParser.statusCode);\r\n\t}\r\n}\r\n\r\nexport const resetPasswordWithOtp = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tconst body = ResetPasswordWithOtpSchema.parse(req.body);\r\n\t\tconst result = await userService.resetPasswordWithOtpService(body.email, body.otp, body.newPassword);\r\n\t\tsuccessHandler(res, result.message, {}, 200);\r\n\t} catch (error) {\r\n\t\tconst errorParser = parseError(error);\r\n\t\terrorHandler(res, \"Failed to reset password\", errorParser.message, errorParser.statusCode);\r\n\t}\r\n}\r\n\r\nexport const resetPasswordWithToken = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tconst body = ResetPasswordWithTokenSchema.parse(req.body);\r\n\t\tconst result = await userService.resetPasswordWithTokenService(body.token, body.newPassword);\r\n\t\tsuccessHandler(res, result.message, {}, 200);\r\n\t} catch (error) {\r\n\t\tconst errorParser = parseError(error);\r\n\t\terrorHandler(res, \"Failed to reset password\", errorParser.message, errorParser.statusCode);\r\n\t}\r\n}\r\n\r\n\r\n\r\nexport const refreshTokenController = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tconst rawToken = req.cookies?.refresh_token;\r\n\t\tif (!rawToken) {\r\n\t\t\terrorHandler(res, \"Refresh token missing\", {}, 401);\r\n\t\t\treturn\r\n\t\t}\r\n\t\t// find session by hashed token\r\n\t\tconst session = await findValidRefreshSession(rawToken);\r\n\t\tif (!session) {\r\n\t\t\terrorHandler(res, \"Invalid or expired refresh token\", {}, 401);\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\tconsole.log(\"session data\", session.dataValues)\r\n\r\n\t\t// Optionally: verify IP / User-Agent consistency here\r\n\t\t// if (session.ip_address !== calculatedIP) { ... }\r\n\r\n\t\t// get user\r\n\t\tconst user = await User.findOne({\r\n\t\t\twhere: { id: session.dataValues.user_id, block: false },\r\n\t\t\tattributes: [\"id\", \"email\"],\r\n\t\t});\r\n\r\n\t\tif (!user) {\r\n\t\t\terrorHandler(res, \"User not found\", {}, 401);\r\n\t\t\treturn\r\n\t\t}\r\n\t\t// rotate refresh token\r\n\t\tconst newRawRefreshToken = await rotateRefreshToken(session, req);\r\n\t\tsetRefreshTokenCookie(res, newRawRefreshToken);\r\n\r\n\t\tconst deviceId = v4();\r\n\t\tconst jti = v4();\r\n\r\n\t\t// new access token\r\n\t\tconst accessToken = generateAccessToken({\r\n\t\t\tid: user.dataValues.id,\r\n\t\t\temail: user.dataValues.email,\r\n\t\t\tdeviceId: deviceId,\r\n\t\t\tjti: jti\r\n\t\t});\r\n\t\tconst redisKeyGen = redisKey(\"session\", user.dataValues.id, deviceId, jti);\r\n\t\tawait redisClient.set(redisKeyGen, accessToken, { EX: 60 * 60 }); // 20 seconds\r\n\r\n\t\tsuccessHandler(res, \"Token Generated\", accessToken, 200)\r\n\t} catch (err: any) {\r\n\t\tconsole.error(\"Refresh token error:\", err);\r\n\t\tconst errorParser = parseError(err)\r\n\t\terrorHandler(res, errorParser.message, err.message, errorParser.statusCode);\r\n\t\treturn\r\n\r\n\t}\r\n};\r\n\r\n\r\n\r\n\r\nexport const logoutController = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tconst rawToken = req.cookies?.refresh_token;\r\n\t\tconst userId = req.user.userId;\r\n\t\tconsole.log(\"raw token \", rawToken)\r\n\r\n\t\tif (rawToken) {\r\n\t\t\tconst session = await findValidRefreshSession(rawToken, userId);\r\n\t\t\tif (session) {\r\n\t\t\t\tawait revokeRefreshSession(session);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tclearRefreshTokenCookie(res);\r\n\t\tlet redisKeyGen = redisKey(\"session\", userId, req.user.deviceId, req.user.jti);\r\n\t\tawait redisClient.del(redisKeyGen);\r\n\t\tsuccessHandler(res, \"Logged out successfully\", {}, 200)\r\n\t} catch (err: any) {\r\n\t\tconsole.error(\"Logout error:\", err);\r\n\t\tconst errorParser = parseError(err);\r\n\t\terrorHandler(res, errorParser.message, err.message, errorParser.statusCode);\r\n\t}\r\n};"],
  "mappings": "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",
  "names": ["User", "redisClient"]
}
