{
  "version": 3,
  "sources": ["../../../../../../../src/modules/ai/chat/chat.controller.ts"],
  "sourcesContent": ["import { Request, Response, NextFunction } from 'express';\r\nimport { ChatService } from './chat.service';\r\nimport { AIService } from '../services/ai.service';\r\nimport { CreateChatSchema, SendMessageSchema, UpdateChatSchema } from './chat.types';\r\n\r\nexport class ChatController {\r\n    // -----------------------------\r\n    // Chat CRUD\r\n    // -----------------------------\r\n\r\n    /**\r\n     * Create a new chat\r\n     */\r\n    static async createChat(req: Request, res: Response, next: NextFunction) {\r\n        try {\r\n            // @ts-ignore - user added by auth middleware\r\n            const userId = req.user.userId;\r\n            const validated = CreateChatSchema.parse(req.body);\r\n\r\n            const chat = await ChatService.createChat(userId, validated.title);\r\n\r\n            res.status(201).json({\r\n                success: true,\r\n                data: chat,\r\n            });\r\n        } catch (error) {\r\n            next(error);\r\n        }\r\n    }\r\n    /**\r\n     * Get all chats for the user\r\n     */\r\n    static async getChats(req: Request, res: Response, next: NextFunction) {\r\n        try {\r\n            // @ts-ignore\r\n            const userId = req.user.userId;\r\n            const page = parseInt(req.query.page as string) || 1;\r\n            const limit = parseInt(req.query.limit as string) || 10;\r\n            const offset = (page - 1) * limit;\r\n\r\n            const chats = await ChatService.getUserChats(userId, limit, offset);\r\n\r\n            res.json({\r\n                success: true,\r\n                data: chats,\r\n            });\r\n        } catch (error) {\r\n            next(error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Update chat metadata\r\n     */\r\n    static async updateChat(req: Request, res: Response, next: NextFunction) {\r\n        try {\r\n            // @ts-ignore\r\n            const userId = req.user.userId;\r\n            const chatId = parseInt(req.params.id);\r\n            const validated = UpdateChatSchema.parse(req.body);\r\n\r\n            const chat = await ChatService.updateChat(chatId, userId, validated);\r\n\r\n            if (!chat) {\r\n                res.status(404).json({ success: false, message: 'Chat not found' });\r\n                return;\r\n            }\r\n\r\n            res.json({\r\n                success: true,\r\n                data: chat,\r\n            });\r\n        } catch (error) {\r\n            next(error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Delete a chat\r\n     */\r\n    static async deleteChat(req: Request, res: Response, next: NextFunction) {\r\n        try {\r\n            // @ts-ignore\r\n            const userId = req.user.userId;\r\n            const chatId = parseInt(req.params.id);\r\n\r\n            const success = await ChatService.deleteChat(chatId, userId);\r\n\r\n            if (!success) {\r\n                res.status(404).json({ success: false, message: 'Chat not found' });\r\n                return;\r\n            }\r\n\r\n            res.json({\r\n                success: true,\r\n                message: 'Chat deleted successfully',\r\n            });\r\n        } catch (error) {\r\n            next(error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get messages for a specific chat\r\n     */\r\n    static async getMessages(req: Request, res: Response, next: NextFunction) {\r\n        try {\r\n            // @ts-ignore\r\n            const userId = req.user.userId;\r\n            const chatId = parseInt(req.params.id);\r\n\r\n            // Verify ownership first\r\n            const chat = await ChatService.getChatById(chatId, userId);\r\n            if (!chat) {\r\n                res.status(404).json({ success: false, message: 'Chat not found' });\r\n                return;\r\n            }\r\n\r\n            // Messages are included in getChatById call above, but we can also fetch separately if needed.\r\n            // For now, let's use the ones included or fetch them.\r\n            // Since getChatById includes messages, we can just return them.\r\n            // But if we want *only* messages, we might want a cleaner response.\r\n            // Let's stick to returning messages from the chat object.\r\n\r\n            res.json({\r\n                success: true,\r\n                data: chat.dataValues.messages || [],\r\n            });\r\n        } catch (error) {\r\n            next(error);\r\n        }\r\n    }\r\n\r\n    // -----------------------------\r\n    // AI Interaction\r\n    // -----------------------------\r\n\r\n    /**\r\n     * Send a message to AI and update chat history\r\n     */\r\n    static async sendMessage(req: Request, res: Response, next: NextFunction) {\r\n        try {\r\n            // @ts-ignore\r\n            const userId = req.user.userId;\r\n\r\n            // 1. Validate Input\r\n            const { chatId, input, provider, model, forceSystemKey } = SendMessageSchema.parse(req.body);\r\n\r\n            // 2. Verify Chat Ownership\r\n            const chat = await ChatService.getChatById(chatId, userId);\r\n            if (!chat) {\r\n                res.status(404).json({ success: false, message: 'Chat not found' });\r\n                return;\r\n            }\r\n\r\n            // 3. Store User Message\r\n            const userMsg = await ChatService.saveMessage(chatId, 'user', input);\r\n\r\n            // 4. Call AI Service (Phase 1 logic)\r\n            // We need to construct an AIRequest object\r\n            const aiRequest = {\r\n                provider: provider as any,\r\n                model,\r\n                input,\r\n            };\r\n\r\n            // Key resolution is handled inside AIService (Phase 3 BYOK)\r\n            const aiResponse = await AIService.executeRequest(userId, aiRequest, forceSystemKey);\r\n\r\n            // 5. Store Assistant Response\r\n            const assistantMsg = await ChatService.saveMessage(chatId, 'assistant', aiResponse.content, {\r\n                provider: aiResponse.provider,\r\n                model: aiResponse.model,\r\n                tokensUsed: aiResponse.tokensUsed,\r\n            });\r\n\r\n            // 6. Return response with both new messages and credit info\r\n            res.json({\r\n                success: true,\r\n                data: {\r\n                    userMessage: userMsg,\r\n                    assistantMessage: assistantMsg,\r\n                    remainingCredits: aiResponse.remainingCredits,\r\n                    creditsUsed: aiResponse.creditsUsed,\r\n                    usingCustomKey: aiResponse.usingCustomKey,\r\n                },\r\n            });\r\n\r\n        } catch (error) {\r\n            next(error);\r\n        }\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": ["import_chat"]
}
