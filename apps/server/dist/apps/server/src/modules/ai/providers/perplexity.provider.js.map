{
  "version": 3,
  "sources": ["../../../../../../../src/modules/ai/providers/perplexity.provider.ts"],
  "sourcesContent": ["import Perplexity from '@perplexity-ai/perplexity_ai';\r\nimport { IAIProvider, AIResponse, AIProviderError, PROVIDER_MODELS } from '../ai.types';\r\n\r\n/**\r\n * Perplexity AI Provider Implementation\r\n * Handles all interactions with Perplexity API\r\n */\r\nexport class PerplexityProvider implements IAIProvider {\r\n    readonly name = 'perplexity' as const;\r\n\r\n    /**\r\n     * Generate AI response using Perplexity\r\n     */\r\n    async generateResponse(\r\n        input: string,\r\n        model: string,\r\n        apiKey: string,\r\n        options?: {\r\n            temperature?: number;\r\n            maxTokens?: number;\r\n        }\r\n    ): Promise<AIResponse> {\r\n        try {\r\n            // Validate model\r\n            if (!this.isModelSupported(model)) {\r\n                throw new AIProviderError(\r\n                    `Model \"${model}\" is not supported by Perplexity. Supported models: ${PROVIDER_MODELS.perplexity.join(', ')}`,\r\n                    'perplexity',\r\n                    400\r\n                );\r\n            }\r\n\r\n            // Initialize Perplexity client with API key\r\n            const client = new Perplexity({ apiKey });\r\n\r\n            // Make API call\r\n            const completion = await client.chat.completions.create({\r\n                model,\r\n                messages: [\r\n                    {\r\n                        role: 'system',\r\n                        content: 'You are a helpful assistant that provides concise, accurate answers.',\r\n                    },\r\n                    {\r\n                        role: 'user',\r\n                        content: input,\r\n                    },\r\n                ],\r\n                temperature: options?.temperature,\r\n                max_tokens: options?.maxTokens,\r\n            });\r\n\r\n            // Extract content from response\r\n            // Perplexity API can return content as string or array of content chunks\r\n            const rawContent = completion.choices?.[0]?.message?.content;\r\n\r\n            let content: string;\r\n            if (typeof rawContent === 'string') {\r\n                content = rawContent;\r\n            } else if (Array.isArray(rawContent)) {\r\n                // Extract text from content chunks (for multimodal responses)\r\n                content = rawContent\r\n                    .filter((chunk: any) => chunk.type === 'text')\r\n                    .map((chunk: any) => chunk.text || '')\r\n                    .join('');\r\n            } else {\r\n                content = '';\r\n            }\r\n\r\n            if (!content) {\r\n                throw new AIProviderError(\r\n                    'Perplexity returned an empty response',\r\n                    'perplexity',\r\n                    500\r\n                );\r\n            }\r\n\r\n            // Strip citation markers like [1], [2], [3] from Perplexity responses\r\n            const cleanContent = this.stripCitations(content);\r\n\r\n            // Return normalized response\r\n            return {\r\n                content: cleanContent,\r\n                provider: 'perplexity',\r\n                model,\r\n                tokensUsed: completion.usage?.total_tokens,\r\n                metadata: {\r\n                    finishReason: completion.choices?.[0]?.finish_reason,\r\n                    citations: completion.citations,\r\n                },\r\n            };\r\n        } catch (error) {\r\n            // Handle Perplexity-specific errors\r\n            if (error instanceof AIProviderError) {\r\n                throw error;\r\n            }\r\n\r\n            // Handle API errors\r\n            const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';\r\n            throw new AIProviderError(\r\n                `Perplexity API error: ${errorMessage}`,\r\n                'perplexity',\r\n                500\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Strip citation markers from Perplexity responses\r\n     * Removes patterns like [1], [2], [3], [1][2], etc.\r\n     * @param text - Text with citation markers\r\n     * @returns Clean text without citations\r\n     */\r\n    private stripCitations(text: string): string {\r\n        // Remove citation markers like [1], [2], [3], [1][2][3], etc.\r\n        return text.replace(/\\[\\d+\\](\\[\\d+\\])*/g, '').trim();\r\n    }\r\n\r\n    /**\r\n     * Check if model is supported by Perplexity\r\n     */\r\n    isModelSupported(model: string): boolean {\r\n        return PROVIDER_MODELS.perplexity.includes(model as any);\r\n    }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2BAAuB;AACvB,gBAA0E;AAMnE,MAAM,mBAA0C;AAAA,EAC1C,OAAO;AAAA;AAAA;AAAA;AAAA,EAKhB,MAAM,iBACF,OACA,OACA,QACA,SAImB;AACnB,QAAI;AAEA,UAAI,CAAC,KAAK,iBAAiB,KAAK,GAAG;AAC/B,cAAM,IAAI;AAAA,UACN,UAAU,KAAK,uDAAuD,0BAAgB,WAAW,KAAK,IAAI,CAAC;AAAA,UAC3G;AAAA,UACA;AAAA,QACJ;AAAA,MACJ;AAGA,YAAM,SAAS,IAAI,qBAAAA,QAAW,EAAE,OAAO,CAAC;AAGxC,YAAM,aAAa,MAAM,OAAO,KAAK,YAAY,OAAO;AAAA,QACpD;AAAA,QACA,UAAU;AAAA,UACN;AAAA,YACI,MAAM;AAAA,YACN,SAAS;AAAA,UACb;AAAA,UACA;AAAA,YACI,MAAM;AAAA,YACN,SAAS;AAAA,UACb;AAAA,QACJ;AAAA,QACA,aAAa,SAAS;AAAA,QACtB,YAAY,SAAS;AAAA,MACzB,CAAC;AAID,YAAM,aAAa,WAAW,UAAU,CAAC,GAAG,SAAS;AAErD,UAAI;AACJ,UAAI,OAAO,eAAe,UAAU;AAChC,kBAAU;AAAA,MACd,WAAW,MAAM,QAAQ,UAAU,GAAG;AAElC,kBAAU,WACL,OAAO,CAAC,UAAe,MAAM,SAAS,MAAM,EAC5C,IAAI,CAAC,UAAe,MAAM,QAAQ,EAAE,EACpC,KAAK,EAAE;AAAA,MAChB,OAAO;AACH,kBAAU;AAAA,MACd;AAEA,UAAI,CAAC,SAAS;AACV,cAAM,IAAI;AAAA,UACN;AAAA,UACA;AAAA,UACA;AAAA,QACJ;AAAA,MACJ;AAGA,YAAM,eAAe,KAAK,eAAe,OAAO;AAGhD,aAAO;AAAA,QACH,SAAS;AAAA,QACT,UAAU;AAAA,QACV;AAAA,QACA,YAAY,WAAW,OAAO;AAAA,QAC9B,UAAU;AAAA,UACN,cAAc,WAAW,UAAU,CAAC,GAAG;AAAA,UACvC,WAAW,WAAW;AAAA,QAC1B;AAAA,MACJ;AAAA,IACJ,SAAS,OAAO;AAEZ,UAAI,iBAAiB,2BAAiB;AAClC,cAAM;AAAA,MACV;AAGA,YAAM,eAAe,iBAAiB,QAAQ,MAAM,UAAU;AAC9D,YAAM,IAAI;AAAA,QACN,yBAAyB,YAAY;AAAA,QACrC;AAAA,QACA;AAAA,MACJ;AAAA,IACJ;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQQ,eAAe,MAAsB;AAEzC,WAAO,KAAK,QAAQ,sBAAsB,EAAE,EAAE,KAAK;AAAA,EACvD;AAAA;AAAA;AAAA;AAAA,EAKA,iBAAiB,OAAwB;AACrC,WAAO,0BAAgB,WAAW,SAAS,KAAY;AAAA,EAC3D;AACJ;",
  "names": ["Perplexity"]
}
