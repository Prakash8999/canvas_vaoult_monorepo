{
  "version": 3,
  "sources": ["../../../../../../../src/modules/ai/chat/chat.service.ts"],
  "sourcesContent": ["import Chat from './models/chat.model';\r\nimport Message from './models/message.model';\r\n\r\nexport class ChatService {\r\n    /**\r\n     * Create a new chat for a user\r\n     */\r\n    static async createChat(userId: number, title: string = 'New Chat'): Promise<Chat> {\r\n        return Chat.create({\r\n            user_id: userId,\r\n            title,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get all chats for a user, sorted by last activity\r\n     */\r\n    static async getUserChats(userId: number, limit: number = 10, offset: number = 0): Promise<Chat[]> {\r\n        return Chat.findAll({\r\n            where: { user_id: userId },\r\n            order: [['last_message_at', 'DESC']],\r\n            limit,\r\n            offset,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get a specific chat by ID (ensuring user ownership)\r\n     */\r\n    static async getChatById(chatId: number, userId: number): Promise<Chat | null> {\r\n        return Chat.findOne({\r\n            where: { id: chatId, user_id: userId },\r\n            include: [\r\n                {\r\n                    model: Message,\r\n                    as: 'messages',\r\n                    order: [['created_at', 'ASC']],\r\n                },\r\n            ],\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Update chat metadata (e.g. title)\r\n     */\r\n    static async updateChat(chatId: number, userId: number, data: { title: string }): Promise<Chat | null> {\r\n        const chat = await Chat.findOne({\r\n            where: { id: chatId, user_id: userId },\r\n        });\r\n\r\n        if (!chat) return null;\r\n\r\n        console.log(`[ChatService] Updating chat ${chatId} title to: ${data.title}`);\r\n        await chat.update({ title: data.title });\r\n        await chat.reload();\r\n\r\n        return chat;\r\n    }\r\n\r\n    /**\r\n     * Delete a chat and all its messages\r\n     */\r\n    static async deleteChat(chatId: number, userId: number): Promise<boolean> {\r\n        const result = await Chat.destroy({\r\n            where: { id: chatId, user_id: userId },\r\n        });\r\n        return result > 0;\r\n    }\r\n\r\n    /**\r\n     * Save a message to a chat\r\n     */\r\n    static async saveMessage(\r\n        chatId: number,\r\n        role: 'user' | 'assistant',\r\n        content: string,\r\n        metadata?: { provider?: string; model?: string; tokensUsed?: number }\r\n    ): Promise<Message> {\r\n        const message = await Message.create({\r\n            chat_id: chatId,\r\n            role,\r\n            content,\r\n            provider: metadata?.provider,\r\n            model: metadata?.model,\r\n            tokens_used: metadata?.tokensUsed,\r\n        });\r\n\r\n        // Update chat's last_message_at\r\n        await Chat.update(\r\n            { last_message_at: new Date(), updated_at: new Date() },\r\n            { where: { id: chatId } }\r\n        );\r\n\r\n        return message;\r\n    }\r\n\r\n    /**\r\n     * Get messages for a specific chat\r\n     */\r\n    static async getMessages(chatId: number): Promise<Message[]> {\r\n        return Message.findAll({\r\n            where: { chat_id: chatId },\r\n            order: [['created_at', 'ASC']],\r\n        });\r\n    }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAAiB;AACjB,qBAAoB;AAEb,MAAM,YAAY;AAAA;AAAA;AAAA;AAAA,EAIrB,aAAa,WAAW,QAAgB,QAAgB,YAA2B;AAC/E,WAAO,YAAAA,QAAK,OAAO;AAAA,MACf,SAAS;AAAA,MACT;AAAA,IACJ,CAAC;AAAA,EACL;AAAA;AAAA;AAAA;AAAA,EAKA,aAAa,aAAa,QAAgB,QAAgB,IAAI,SAAiB,GAAoB;AAC/F,WAAO,YAAAA,QAAK,QAAQ;AAAA,MAChB,OAAO,EAAE,SAAS,OAAO;AAAA,MACzB,OAAO,CAAC,CAAC,mBAAmB,MAAM,CAAC;AAAA,MACnC;AAAA,MACA;AAAA,IACJ,CAAC;AAAA,EACL;AAAA;AAAA;AAAA;AAAA,EAKA,aAAa,YAAY,QAAgB,QAAsC;AAC3E,WAAO,YAAAA,QAAK,QAAQ;AAAA,MAChB,OAAO,EAAE,IAAI,QAAQ,SAAS,OAAO;AAAA,MACrC,SAAS;AAAA,QACL;AAAA,UACI,OAAO,eAAAC;AAAA,UACP,IAAI;AAAA,UACJ,OAAO,CAAC,CAAC,cAAc,KAAK,CAAC;AAAA,QACjC;AAAA,MACJ;AAAA,IACJ,CAAC;AAAA,EACL;AAAA;AAAA;AAAA;AAAA,EAKA,aAAa,WAAW,QAAgB,QAAgB,MAA+C;AACnG,UAAM,OAAO,MAAM,YAAAD,QAAK,QAAQ;AAAA,MAC5B,OAAO,EAAE,IAAI,QAAQ,SAAS,OAAO;AAAA,IACzC,CAAC;AAED,QAAI,CAAC;AAAM,aAAO;AAElB,YAAQ,IAAI,+BAA+B,MAAM,cAAc,KAAK,KAAK,EAAE;AAC3E,UAAM,KAAK,OAAO,EAAE,OAAO,KAAK,MAAM,CAAC;AACvC,UAAM,KAAK,OAAO;AAElB,WAAO;AAAA,EACX;AAAA;AAAA;AAAA;AAAA,EAKA,aAAa,WAAW,QAAgB,QAAkC;AACtE,UAAM,SAAS,MAAM,YAAAA,QAAK,QAAQ;AAAA,MAC9B,OAAO,EAAE,IAAI,QAAQ,SAAS,OAAO;AAAA,IACzC,CAAC;AACD,WAAO,SAAS;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,aAAa,YACT,QACA,MACA,SACA,UACgB;AAChB,UAAM,UAAU,MAAM,eAAAC,QAAQ,OAAO;AAAA,MACjC,SAAS;AAAA,MACT;AAAA,MACA;AAAA,MACA,UAAU,UAAU;AAAA,MACpB,OAAO,UAAU;AAAA,MACjB,aAAa,UAAU;AAAA,IAC3B,CAAC;AAGD,UAAM,YAAAD,QAAK;AAAA,MACP,EAAE,iBAAiB,oBAAI,KAAK,GAAG,YAAY,oBAAI,KAAK,EAAE;AAAA,MACtD,EAAE,OAAO,EAAE,IAAI,OAAO,EAAE;AAAA,IAC5B;AAEA,WAAO;AAAA,EACX;AAAA;AAAA;AAAA;AAAA,EAKA,aAAa,YAAY,QAAoC;AACzD,WAAO,eAAAC,QAAQ,QAAQ;AAAA,MACnB,OAAO,EAAE,SAAS,OAAO;AAAA,MACzB,OAAO,CAAC,CAAC,cAAc,KAAK,CAAC;AAAA,IACjC,CAAC;AAAA,EACL;AACJ;",
  "names": ["Chat", "Message"]
}
