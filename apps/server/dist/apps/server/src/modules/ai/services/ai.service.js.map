{
  "version": 3,
  "sources": ["../../../../../../../src/modules/ai/services/ai.service.ts"],
  "sourcesContent": ["import { AIProviderFactory } from '../providers/provider.factory';\r\nimport { AICreditsService } from './credits.service';\r\nimport { InputValidationService } from './validation.service';\r\nimport { ModelManagementService } from '../byok/model-management.service';\r\nimport {\r\n    AIRequest,\r\n    AIServiceResponse,\r\n    AI_CONSTRAINTS,\r\n    AIProviderError,\r\n    InsufficientCreditsError,\r\n} from '../ai.types';\r\n\r\n/**\r\n * Main AI Service\r\n * Orchestrates the entire AI request flow:\r\n * 1. Validate input\r\n * 2. Check credits\r\n * 3. Execute AI request\r\n * 4. Deduct credits on success\r\n * 5. Return response with remaining credits\r\n */\r\nexport class AIService {\r\n    /**\r\n     * Execute AI request\r\n     * @param userId - User ID making the request\r\n     * @param request - AI request details\r\n     * @param forceSystemKey - If true, use system key even if user has custom key\r\n     * @returns AI response with credit information\r\n     */\r\n    static async executeRequest(\r\n        userId: number,\r\n        request: AIRequest,\r\n        forceSystemKey?: boolean\r\n    ): Promise<AIServiceResponse> {\r\n        // STEP 1: Validate input\r\n        InputValidationService.validateRequest(request);\r\n\r\n        // STEP 2: Resolve Model & Key (Phase 3 BYOK)\r\n        // This determines which key to use and whether to deduct credits\r\n        const resolvedConfig = await ModelManagementService.resolveModelConfig(\r\n            userId,\r\n            request.provider,\r\n            request.model,\r\n            forceSystemKey\r\n        );\r\n        const { apiKey, isUserKey } = resolvedConfig;\r\n\r\n        // STEP 3: Check credits (Only if using System Key)\r\n        if (!isUserKey) {\r\n            const hasCredits = await AICreditsService.hasCredits(\r\n                userId,\r\n                AI_CONSTRAINTS.CREDIT_COST_PER_REQUEST\r\n            );\r\n\r\n            if (!hasCredits) {\r\n                const available = await AICreditsService.getUserCredits(userId);\r\n                throw new InsufficientCreditsError(\r\n                    AI_CONSTRAINTS.CREDIT_COST_PER_REQUEST,\r\n                    available\r\n                );\r\n            }\r\n        }\r\n\r\n        // STEP 4: Resolve provider\r\n        const provider = AIProviderFactory.getProvider(resolvedConfig.provider);\r\n\r\n        // STEP 5: Execute AI request\r\n        let aiResponse;\r\n        try {\r\n            aiResponse = await provider.generateResponse(\r\n                request.input,\r\n                request.model, // Use detailed model from request or resolved? Request has 'model'\r\n                apiKey,\r\n                request.options\r\n            );\r\n        } catch (error) {\r\n            // If AI call fails, do NOT deduct credits\r\n            if (error instanceof AIProviderError) {\r\n                throw error;\r\n            }\r\n            throw new AIProviderError(\r\n                `AI request failed: ${error instanceof Error ? error.message : 'Unknown error'} `,\r\n                request.provider,\r\n                500\r\n            );\r\n        }\r\n\r\n        // STEP 6: Deduct credits (only on successful response AND if using System Key)\r\n        let remainingCredits = await AICreditsService.getUserCredits(userId);\r\n        let creditsUsed = 0;\r\n\r\n        console.log(`[AI Service] isUserKey: ${isUserKey}, Current Credits: ${remainingCredits}`);\r\n\r\n        if (!isUserKey) {\r\n            remainingCredits = await AICreditsService.deductCredits(\r\n                userId,\r\n                AI_CONSTRAINTS.CREDIT_COST_PER_REQUEST\r\n            );\r\n            creditsUsed = AI_CONSTRAINTS.CREDIT_COST_PER_REQUEST;\r\n            console.log(`[AI Service] Credits deducted. New balance: ${remainingCredits}, Used: ${creditsUsed}`);\r\n        } else {\r\n            console.log(`[AI Service] Using custom key - NO credits deducted`);\r\n        }\r\n\r\n        // STEP 7: Return response with credit info\r\n        return {\r\n            ...aiResponse,\r\n            remainingCredits,\r\n            creditsUsed,\r\n            usingCustomKey: isUserKey, // Explicitly indicate if BYOK was used\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get user's remaining credits\r\n     * @param userId - User ID\r\n     * @returns Remaining credits\r\n     */\r\n    static async getRemainingCredits(userId: number): Promise<number> {\r\n        return AICreditsService.getUserCredits(userId);\r\n    }\r\n\r\n    /**\r\n     * Get AI constraints and supported providers/models\r\n     * Useful for frontend to display available options\r\n     */\r\n    static getConstraints() {\r\n        return InputValidationService.getConstraints();\r\n    }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBAAkC;AAClC,qBAAiC;AACjC,wBAAuC;AACvC,8BAAuC;AACvC,gBAMO;AAWA,MAAM,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQnB,aAAa,eACT,QACA,SACA,gBAC0B;AAE1B,6CAAuB,gBAAgB,OAAO;AAI9C,UAAM,iBAAiB,MAAM,+CAAuB;AAAA,MAChD;AAAA,MACA,QAAQ;AAAA,MACR,QAAQ;AAAA,MACR;AAAA,IACJ;AACA,UAAM,EAAE,QAAQ,UAAU,IAAI;AAG9B,QAAI,CAAC,WAAW;AACZ,YAAM,aAAa,MAAM,gCAAiB;AAAA,QACtC;AAAA,QACA,yBAAe;AAAA,MACnB;AAEA,UAAI,CAAC,YAAY;AACb,cAAM,YAAY,MAAM,gCAAiB,eAAe,MAAM;AAC9D,cAAM,IAAI;AAAA,UACN,yBAAe;AAAA,UACf;AAAA,QACJ;AAAA,MACJ;AAAA,IACJ;AAGA,UAAM,WAAW,kCAAkB,YAAY,eAAe,QAAQ;AAGtE,QAAI;AACJ,QAAI;AACA,mBAAa,MAAM,SAAS;AAAA,QACxB,QAAQ;AAAA,QACR,QAAQ;AAAA;AAAA,QACR;AAAA,QACA,QAAQ;AAAA,MACZ;AAAA,IACJ,SAAS,OAAO;AAEZ,UAAI,iBAAiB,2BAAiB;AAClC,cAAM;AAAA,MACV;AACA,YAAM,IAAI;AAAA,QACN,sBAAsB,iBAAiB,QAAQ,MAAM,UAAU,eAAe;AAAA,QAC9E,QAAQ;AAAA,QACR;AAAA,MACJ;AAAA,IACJ;AAGA,QAAI,mBAAmB,MAAM,gCAAiB,eAAe,MAAM;AACnE,QAAI,cAAc;AAElB,YAAQ,IAAI,2BAA2B,SAAS,sBAAsB,gBAAgB,EAAE;AAExF,QAAI,CAAC,WAAW;AACZ,yBAAmB,MAAM,gCAAiB;AAAA,QACtC;AAAA,QACA,yBAAe;AAAA,MACnB;AACA,oBAAc,yBAAe;AAC7B,cAAQ,IAAI,+CAA+C,gBAAgB,WAAW,WAAW,EAAE;AAAA,IACvG,OAAO;AACH,cAAQ,IAAI,qDAAqD;AAAA,IACrE;AAGA,WAAO;AAAA,MACH,GAAG;AAAA,MACH;AAAA,MACA;AAAA,MACA,gBAAgB;AAAA;AAAA,IACpB;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,aAAa,oBAAoB,QAAiC;AAC9D,WAAO,gCAAiB,eAAe,MAAM;AAAA,EACjD;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,OAAO,iBAAiB;AACpB,WAAO,yCAAuB,eAAe;AAAA,EACjD;AACJ;",
  "names": []
}
