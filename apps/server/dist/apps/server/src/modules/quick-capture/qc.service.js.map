{
  "version": 3,
  "sources": ["../../../../../../src/modules/quick-capture/qc.service.ts"],
  "sourcesContent": ["import { NoteCreationAttributes, NoteQueryAttributes, NoteUpdateAttributes } from \"../notes/notes.model\";\r\nimport { Op, Transaction } from 'sequelize';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { Note } from \"../shared/model/model.relation\";\r\nimport sequelize from \"../../config/database\";\r\nimport redisClient from \"../../config/redis\";\r\nimport { paginateAndSort } from \"../../common/utils/pagination.utils\";\r\n\r\n// Helper: Deletes all list caches recorded in the user's tracker\r\nconst invalidateUserCache = async (userId: number) => {\r\n    const trackerKey = `user:${userId}:qc_cache_tracker`;\r\n    const keysToDelete = await redisClient.sMembers(trackerKey);\r\n\r\n    if (keysToDelete.length > 0) {\r\n        const pipeline = redisClient.multi();\r\n        pipeline.del(keysToDelete); // Delete the actual cached lists\r\n        pipeline.del(trackerKey);   // Delete the tracker itself\r\n        await pipeline.exec();\r\n        console.log(`Invalidated ${keysToDelete.length} qc cache keys for user ${userId}`);\r\n    }\r\n};\r\n\r\nexport const createQuickCaptureService = async (data: NoteCreationAttributes, userId: number): Promise<Note> => {\r\n    const transaction: Transaction = await sequelize.transaction();\r\n\r\n    try {\r\n        const note_uid = uuidv4();\r\n\r\n        const noteData = {\r\n            ...data,\r\n            user_id: userId,\r\n            note_type: 'quick_capture' as 'quick_capture',\r\n            version: 1,\r\n            note_uid,\r\n            created_at: new Date(),\r\n            updated_at: new Date(),\r\n        };\r\n\r\n        const note = await Note.create(noteData, { transaction });\r\n\r\n        await transaction.commit();\r\n        await invalidateUserCache(userId);\r\n\r\n        return note;\r\n    } catch (error) {\r\n        await transaction.rollback();\r\n        console.error('Error creating quick capture:', error);\r\n        throw error;\r\n    }\r\n};\r\n\r\nexport const getAllQuickCapturesService = async (\r\n    userId: number,\r\n    filters: NoteQueryAttributes = {}\r\n): Promise<{ data: Note[], meta: any }> => {\r\n    try {\r\n        const {\r\n            search,\r\n            page = 1,\r\n            limit = 10,\r\n            sort = 'desc',\r\n            sort_by = 'updated_at',\r\n            ...modelFilters\r\n        } = filters;\r\n\r\n        // Calculate offset from page\r\n        const offset = (page - 1) * limit;\r\n\r\n        // Redis key for caching\r\n        const redisKeyGen = `qc:${userId}:${limit}:${offset}:${search || ''}:${JSON.stringify(modelFilters)}:${sort}:${sort_by}`;\r\n        const trackerKey = `user:${userId}:qc_cache_tracker`;\r\n\r\n        const cachedNotes = await redisClient.get(redisKeyGen);\r\n        if (cachedNotes) {\r\n            console.log('Quick captures found in cache');\r\n            return JSON.parse(cachedNotes);\r\n        }\r\n\r\n        console.log('Quick captures not found in cache');\r\n\r\n        const whereClause: any = { user_id: userId, note_type: 'quick_capture' };\r\n\r\n        // Apply model-based filters\r\n        if (modelFilters.id !== undefined) whereClause.id = modelFilters.id;\r\n        if (modelFilters.note_uid !== undefined) whereClause.note_uid = modelFilters.note_uid;\r\n        if (modelFilters.pinned !== undefined) whereClause.pinned = modelFilters.pinned;\r\n        if (modelFilters.created_at !== undefined) whereClause.created_at = modelFilters.created_at;\r\n        if (modelFilters.updated_at !== undefined) whereClause.updated_at = modelFilters.updated_at;\r\n\r\n        // Handle title filter\r\n        if (modelFilters.title !== undefined) {\r\n            whereClause.title = modelFilters.title;\r\n        }\r\n\r\n        // Handle search\r\n        if (search) {\r\n            whereClause.title = { [Op.iLike]: `%${search}%` };\r\n        }\r\n\r\n        const result = await paginateAndSort<Note>(\r\n            Note,\r\n            whereClause,\r\n            page,\r\n            limit,\r\n            [[sort_by, sort.toUpperCase()]],\r\n            undefined,\r\n            ['id', 'note_uid', 'user_id', 'title', 'content', 'tags', 'version', 'pinned', 'created_at', 'updated_at']\r\n        );\r\n\r\n        // Cache using pipeline\r\n        const pipeline = redisClient.multi();\r\n        pipeline.set(redisKeyGen, JSON.stringify(result), {\r\n            EX: 60 * 60, // 1 hour\r\n        });\r\n        pipeline.sAdd(trackerKey, redisKeyGen);\r\n        pipeline.expire(trackerKey, 60 * 60);\r\n\r\n        await pipeline.exec();\r\n\r\n        return result;\r\n    } catch (error) {\r\n        console.error('Error fetching quick captures:', error);\r\n        throw error;\r\n    }\r\n};\r\n\r\nexport const getQuickCaptureByIdService = async (id: number, userId: number): Promise<Note | null> => {\r\n    try {\r\n        const cacheKey = `qc:id:${id}:${userId}`;\r\n\r\n        const cachedNote = await redisClient.get(cacheKey);\r\n        if (cachedNote) {\r\n            console.log('Quick capture found in cache');\r\n            return JSON.parse(cachedNote);\r\n        }\r\n\r\n        const note = await Note.findOne({\r\n            where: { id: id, user_id: userId, note_type: 'quick_capture' },\r\n            raw: true,\r\n            nest: true,\r\n        });\r\n\r\n        if (note) {\r\n            await redisClient.set(cacheKey, JSON.stringify(note), {\r\n                EX: 60 * 30, // Cache for 30 minutes\r\n            });\r\n        }\r\n\r\n        console.log('Fetched quick capture by id:', id, note ? 'found' : 'not found');\r\n        return note;\r\n    } catch (error) {\r\n        console.error('Error fetching quick capture:', error);\r\n        throw error;\r\n    }\r\n};\r\n\r\nexport const updateQuickCaptureService = async (\r\n    id: number,\r\n    data: NoteUpdateAttributes,\r\n    userId: number\r\n): Promise<Note | null> => {\r\n    const transaction: Transaction = await sequelize.transaction();\r\n\r\n    try {\r\n        // 1. Check ownership\r\n        const existingNote = await Note.findOne({\r\n            where: { id, user_id: userId, note_type: 'quick_capture' },\r\n            transaction,\r\n        });\r\n\r\n        if (!existingNote) {\r\n            throw new Error(\"Quick capture not found\");\r\n        }\r\n\r\n        // 2. Version increment\r\n        const currentVersion: number = existingNote.dataValues.version || 0;\r\n        const note_type = existingNote.dataValues.note_type || 'quick_capture';\r\n\r\n        const updateData = {\r\n            ...data,\r\n            note_type: note_type,\r\n            version: currentVersion + 1,\r\n            updated_at: new Date(),\r\n        };\r\n\r\n        // 3. Update inside transaction\r\n        await Note.update(updateData, {\r\n            where: { id, user_id: userId },\r\n            transaction,\r\n        });\r\n\r\n        await redisClient.del(`qc:id:${id}:${userId}`);\r\n        await invalidateUserCache(userId);\r\n\r\n        // 4. Commit transaction\r\n        await transaction.commit();\r\n\r\n        // 5. Fetch and return updated note\r\n        return await Note.findByPk(id);\r\n\r\n    } catch (error) {\r\n        console.error(\"Error updating quick capture:\", error);\r\n        await transaction.rollback();\r\n        throw error;\r\n    }\r\n};\r\n\r\nexport const deleteQuickCaptureService = async (id: number, userId: number): Promise<boolean> => {\r\n    try {\r\n        const note = await Note.findOne({\r\n            where: { id: id, user_id: userId, note_type: 'quick_capture' },\r\n            raw: true,\r\n            attributes: ['id']\r\n        });\r\n\r\n        if (!note) {\r\n            return false;\r\n        }\r\n\r\n        const deletedRows = await Note.destroy({\r\n            where: { id, user_id: userId }\r\n        });\r\n\r\n        if (deletedRows > 0) {\r\n            await redisClient.del(`qc:id:${id}:${userId}`);\r\n            await invalidateUserCache(userId);\r\n        }\r\n\r\n        return deletedRows > 0;\r\n    } catch (error) {\r\n        console.error('Error deleting quick capture:', error);\r\n        throw error;\r\n    }\r\n};\r\n"],
  "mappings": "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",
  "names": ["redisClient", "sequelize", "uuidv4"]
}
