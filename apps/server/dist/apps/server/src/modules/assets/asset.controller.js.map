{
  "version": 3,
  "sources": ["../../../../../../src/modules/assets/asset.controller.ts"],
  "sourcesContent": ["\uFEFFimport { Request, Response, NextFunction } from \"express\";\r\nimport { errorHandler, successHandler } from \"../../common/middlewares/responseHandler\";\r\nimport { assetService } from \"./asset.service\";\r\nimport { createUploadMiddleware, MulterS3File } from \"../../common/libs/multer/multer-s3\";\r\nimport ImageAssets from \"./asset.model\";\r\n\r\n\r\nexport const dynamicUploadImages = (req: Request, res: Response, next: NextFunction) => {\r\n\tif (!req.user || !req.user.userId) {\r\n\t\terrorHandler(res, \"Unauthorized: User information is missing\", {}, 401);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst fileType = req.query?.fileType as string;\r\n\tconst upload = createUploadMiddleware(req.user.userId, fileType);\r\n\r\n\tupload(req, res, function (err) {\r\n\t\tconsole.log('error ', err);\r\n\t\tif (err) {\r\n\t\t\terrorHandler(res, err.message, {}, 500);\r\n\t\t\treturn\r\n\t\t}\r\n\t\tnext();\r\n\t\treturn\r\n\t});\r\n};\r\n\r\n/**\r\n * Handle image upload response\r\n */\r\nexport const handleUploadImages = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tconst file = req.file as MulterS3File;\r\n\t\tif (!file) {\r\n\t\t\treturn errorHandler(res, \"No file uploaded\", {}, 400);\r\n\t\t}\r\n\r\n\r\n\t\t// Additional validation for image files\r\n\t\tconst allowedMimes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];\r\n\t\tif (!allowedMimes.includes(file.mimetype)) {\r\n\t\t\treturn errorHandler(res, \"Only image files are allowed\", {}, 400);\r\n\t\t}\r\n\r\n\t\tlet { asset_type, fileType } = req.body;\r\n\r\n\t\tif (!asset_type) {\r\n\t\t\tconst type = (req.query?.fileType as string) || fileType;\r\n\t\t\tif (type) {\r\n\t\t\t\tif (type === 'note' || type === 'notes') asset_type = 'Note';\r\n\t\t\t\telse if (type === 'canvas') asset_type = 'Canvas';\r\n\t\t\t}\r\n\t\t}\r\n\r\n\r\n\t\tconst uploadedFile = assetService.processUploadedFile(file);\r\n\t\tconst resData = await ImageAssets.create({\r\n\t\t\tasset_type,\r\n\t\t\tuser_Id: req.user.userId,\r\n\t\t\ts3_key: uploadedFile.key,\r\n\t\t\tsize_kb: Math.round(uploadedFile.size),\r\n\t\t\tfile_type: file.mimetype,\r\n\t\t\turl: uploadedFile.url,\r\n\t\t\tfile_name: file.originalname,\r\n\t\t\tcreated_at: new Date(),\r\n\t\t\tupdated_at: new Date(),\r\n\t\t});\r\n\r\n\t\tconst sendData = {\r\n\t\t\tid: resData.dataValues.id,\r\n\t\t\t...uploadedFile,\r\n\t\t}\r\n\t\treturn successHandler(res, \"Image uploaded to S3 successfully\", sendData, 200);\r\n\t} catch (error: any) {\r\n\t\tconsole.error(\"Error uploading image:\", error);\r\n\t\treturn errorHandler(res, error.message || \"Image upload failed\", {}, 500);\r\n\t}\r\n};\r\n\r\n/**\r\n * Delete multiple S3 files\r\n */\r\nexport const deleteMultipleS3Files = async (req: Request, res: Response) => {\r\n\ttry {\r\n\t\tconst { keys } = req.body;\r\n\r\n\t\tif (!keys || !Array.isArray(keys) || keys.length === 0) {\r\n\t\t\terrorHandler(res, \"Keys array is required\", {}, 400);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst result = await assetService.deleteMultipleFiles(keys);\r\n\t\tsuccessHandler(res, result.message, result, 200);\r\n\t\treturn;\r\n\t} catch (error: any) {\r\n\t\terrorHandler(res, error.message || \"Failed to delete files\", {}, 500);\r\n\t\treturn;\r\n\t}\r\n};\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,6BAA6C;AAC7C,mBAA6B;AAC7B,uBAAqD;AACrD,IAAAA,gBAAwB;AAGjB,MAAM,sBAAsB,CAAC,KAAc,KAAe,SAAuB;AACvF,MAAI,CAAC,IAAI,QAAQ,CAAC,IAAI,KAAK,QAAQ;AAClC,6CAAa,KAAK,6CAA6C,CAAC,GAAG,GAAG;AACtE;AAAA,EACD;AAEA,QAAM,WAAW,IAAI,OAAO;AAC5B,QAAM,aAAS,yCAAuB,IAAI,KAAK,QAAQ,QAAQ;AAE/D,SAAO,KAAK,KAAK,SAAU,KAAK;AAC/B,YAAQ,IAAI,UAAU,GAAG;AACzB,QAAI,KAAK;AACR,+CAAa,KAAK,IAAI,SAAS,CAAC,GAAG,GAAG;AACtC;AAAA,IACD;AACA,SAAK;AACL;AAAA,EACD,CAAC;AACF;AAKO,MAAM,qBAAqB,OAAO,KAAc,QAAkB;AACxE,MAAI;AACH,UAAM,OAAO,IAAI;AACjB,QAAI,CAAC,MAAM;AACV,iBAAO,qCAAa,KAAK,oBAAoB,CAAC,GAAG,GAAG;AAAA,IACrD;AAIA,UAAM,eAAe,CAAC,cAAc,aAAa,aAAa,aAAa,cAAc,eAAe;AACxG,QAAI,CAAC,aAAa,SAAS,KAAK,QAAQ,GAAG;AAC1C,iBAAO,qCAAa,KAAK,gCAAgC,CAAC,GAAG,GAAG;AAAA,IACjE;AAEA,QAAI,EAAE,YAAY,SAAS,IAAI,IAAI;AAEnC,QAAI,CAAC,YAAY;AAChB,YAAM,OAAQ,IAAI,OAAO,YAAuB;AAChD,UAAI,MAAM;AACT,YAAI,SAAS,UAAU,SAAS;AAAS,uBAAa;AAAA,iBAC7C,SAAS;AAAU,uBAAa;AAAA,MAC1C;AAAA,IACD;AAGA,UAAM,eAAe,0BAAa,oBAAoB,IAAI;AAC1D,UAAM,UAAU,MAAM,cAAAC,QAAY,OAAO;AAAA,MACxC;AAAA,MACA,SAAS,IAAI,KAAK;AAAA,MAClB,QAAQ,aAAa;AAAA,MACrB,SAAS,KAAK,MAAM,aAAa,IAAI;AAAA,MACrC,WAAW,KAAK;AAAA,MAChB,KAAK,aAAa;AAAA,MAClB,WAAW,KAAK;AAAA,MAChB,YAAY,oBAAI,KAAK;AAAA,MACrB,YAAY,oBAAI,KAAK;AAAA,IACtB,CAAC;AAED,UAAM,WAAW;AAAA,MAChB,IAAI,QAAQ,WAAW;AAAA,MACvB,GAAG;AAAA,IACJ;AACA,eAAO,uCAAe,KAAK,qCAAqC,UAAU,GAAG;AAAA,EAC9E,SAAS,OAAY;AACpB,YAAQ,MAAM,0BAA0B,KAAK;AAC7C,eAAO,qCAAa,KAAK,MAAM,WAAW,uBAAuB,CAAC,GAAG,GAAG;AAAA,EACzE;AACD;AAKO,MAAM,wBAAwB,OAAO,KAAc,QAAkB;AAC3E,MAAI;AACH,UAAM,EAAE,KAAK,IAAI,IAAI;AAErB,QAAI,CAAC,QAAQ,CAAC,MAAM,QAAQ,IAAI,KAAK,KAAK,WAAW,GAAG;AACvD,+CAAa,KAAK,0BAA0B,CAAC,GAAG,GAAG;AACnD;AAAA,IACD;AAEA,UAAM,SAAS,MAAM,0BAAa,oBAAoB,IAAI;AAC1D,+CAAe,KAAK,OAAO,SAAS,QAAQ,GAAG;AAC/C;AAAA,EACD,SAAS,OAAY;AACpB,6CAAa,KAAK,MAAM,WAAW,0BAA0B,CAAC,GAAG,GAAG;AACpE;AAAA,EACD;AACD;",
  "names": ["import_asset", "ImageAssets"]
}
