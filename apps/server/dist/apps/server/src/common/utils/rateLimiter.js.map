{
  "version": 3,
  "sources": ["../../../../../../src/common/utils/rateLimiter.ts"],
  "sourcesContent": ["import { Request, Response, NextFunction } from \"express\";\r\nimport { errorHandler } from \"../middlewares/responseHandler\";\r\n\r\ninterface RateLimitData {\r\n\tcount: number;\r\n\tresetTime: number;\r\n}\r\n\r\nclass RateLimiter {\r\n\tprivate static instance: RateLimiter;\r\n\tprivate requests = new Map<string, RateLimitData>();\r\n\tprivate cleanupInterval: NodeJS.Timeout;\r\n\r\n\tprivate constructor() {\r\n\t\t// Clean up expired entries every 5 minutes\r\n\t\tthis.cleanupInterval = setInterval(() => {\r\n\t\t\tconst now = Date.now();\r\n\t\t\tfor (const [key, data] of this.requests.entries()) {\r\n\t\t\t\tif (now > data.resetTime) {\r\n\t\t\t\t\tthis.requests.delete(key);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}, 5 * 60 * 1000);\r\n\t}\r\n\r\n\tpublic static getInstance(): RateLimiter {\r\n\t\tif (!RateLimiter.instance) {\r\n\t\t\tRateLimiter.instance = new RateLimiter();\r\n\t\t}\r\n\t\treturn RateLimiter.instance;\r\n\t}\r\n\r\n\tpublic isAllowed(key: string, limit: number, windowMs: number): boolean {\r\n\t\tconst now = Date.now();\r\n\t\tconst data = this.requests.get(key);\r\n\r\n\t\tif (!data || now > data.resetTime) {\r\n\t\t\t// First request or window expired, reset\r\n\t\t\tthis.requests.set(key, {\r\n\t\t\t\tcount: 1,\r\n\t\t\t\tresetTime: now + windowMs\r\n\t\t\t});\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\tif (data.count >= limit) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\t// Increment count\r\n\t\tdata.count++;\r\n\t\treturn true;\r\n\t}\r\n\r\n\tpublic getRemainingRequests(key: string, limit: number): number {\r\n\t\tconst data = this.requests.get(key);\r\n\t\tif (!data || Date.now() > data.resetTime) {\r\n\t\t\treturn limit;\r\n\t\t}\r\n\t\treturn Math.max(0, limit - data.count);\r\n\t}\r\n\r\n\tpublic getResetTime(key: string): number | null {\r\n\t\tconst data = this.requests.get(key);\r\n\t\tif (!data || Date.now() > data.resetTime) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\treturn data.resetTime;\r\n\t}\r\n\r\n\tpublic decrementCount(key: string): void {\r\n\t\tconst data = this.requests.get(key);\r\n\t\tif (data && data.count > 0) {\r\n\t\t\tdata.count--;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic destroy(): void {\r\n\t\tif (this.cleanupInterval) {\r\n\t\t\tclearInterval(this.cleanupInterval);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nconst rateLimiter = RateLimiter.getInstance();\r\n\r\ninterface RateLimitOptions {\r\n\twindowMs?: number; // Time window in milliseconds (default: 15 minutes)\r\n\tmax?: number; // Maximum requests per window (default: 100)\r\n\tkeyGenerator?: (req: Request) => string; // Function to generate rate limit key\r\n\tskipSuccessfulRequests?: boolean; // Don't count successful requests\r\n\tskipFailedRequests?: boolean; // Don't count failed requests\r\n\tmessage?: string; // Error message when rate limit is exceeded\r\n}\r\n\r\nexport const createRateLimit = (options: RateLimitOptions = {}) => {\r\n\tconst {\r\n\t\twindowMs = 15 * 60 * 1000, // 15 minutes\r\n\t\tmax = 100,\r\n\t\tkeyGenerator = (req: Request) => req.ip || 'unknown',\r\n\t\tskipSuccessfulRequests = false,\r\n\t\tskipFailedRequests = false,\r\n\t\tmessage = 'Too many requests, please try again later.'\r\n\t} = options;\r\n\r\n\treturn (req: Request, res: Response, next: NextFunction): void => {\r\n\t\tconst key = keyGenerator(req);\r\n\t\t\r\n\t\tif (!rateLimiter.isAllowed(key, max, windowMs)) {\r\n\t\t\tconst resetTime = rateLimiter.getResetTime(key);\r\n\t\t\tconst retryAfter = resetTime ? Math.ceil((resetTime - Date.now()) / 1000) : 0;\r\n\t\t\t\r\n\t\t\tres.set({\r\n\t\t\t\t'X-RateLimit-Limit': max.toString(),\r\n\t\t\t\t'X-RateLimit-Remaining': '0',\r\n\t\t\t\t'X-RateLimit-Reset': resetTime ? Math.ceil(resetTime / 1000).toString() : '',\r\n\t\t\t\t'Retry-After': retryAfter.toString()\r\n\t\t\t});\r\n\r\n\t\t\terrorHandler(res, message, {}, 429);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Set rate limit headers\r\n\t\tconst remaining = rateLimiter.getRemainingRequests(key, max);\r\n\t\tconst resetTime = rateLimiter.getResetTime(key);\r\n\t\t\r\n\t\tres.set({\r\n\t\t\t'X-RateLimit-Limit': max.toString(),\r\n\t\t\t'X-RateLimit-Remaining': remaining.toString(),\r\n\t\t\t'X-RateLimit-Reset': resetTime ? Math.ceil(resetTime / 1000).toString() : ''\r\n\t\t});\r\n\r\n\t\t// If we need to skip counting on response, we'll handle it in response\r\n\t\tlet shouldCount = true;\r\n\t\t\r\n\t\tif (skipSuccessfulRequests || skipFailedRequests) {\r\n\t\t\tconst originalSend = res.send;\r\n\t\t\tres.send = function(data) {\r\n\t\t\t\tconst statusCode = res.statusCode;\r\n\t\t\t\t\r\n\t\t\t\tif (skipSuccessfulRequests && statusCode >= 200 && statusCode < 300) {\r\n\t\t\t\t\tshouldCount = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (skipFailedRequests && statusCode >= 400) {\r\n\t\t\t\t\tshouldCount = false;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// If we shouldn't count this request, we need to decrement\r\n\t\t\t\tif (!shouldCount) {\r\n\t\t\t\t\trateLimiter.decrementCount(key);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\treturn originalSend.call(this, data);\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tnext();\r\n\t};\r\n};\r\n\r\n// Predefined rate limiters for common use cases\r\nexport const authRateLimit = createRateLimit({\r\n\twindowMs: 15 * 60 * 1000, // 15 minutes\r\n\tmax: 10, // 10 login attempts per 15 minutes\r\n\tkeyGenerator: (req: Request) => `auth:${req.ip}`,\r\n\tmessage: 'Too many authentication attempts, please try again later.'\r\n});\r\n\r\nexport const generalRateLimit = createRateLimit({\r\n\twindowMs: 15 * 60 * 1000, // 15 minutes\r\n\tmax: 1000, // 1000 requests per 15 minutes\r\n\tmessage: 'Too many requests, please try again later.'\r\n});\r\n\r\nexport const strictRateLimit = createRateLimit({\r\n\twindowMs: 1 * 60 * 1000, // 1 minute\r\n\tmax: 5, // 5 requests per minute\r\n\tmessage: 'Rate limit exceeded. Please wait before making more requests.'\r\n});"],
  "mappings": "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",
  "names": ["resetTime"]
}
