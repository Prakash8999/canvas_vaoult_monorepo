{
  "version": 3,
  "sources": ["../../../../../../../src/common/libs/multer/multer-s3.ts"],
  "sourcesContent": ["import multer from \"multer\";\r\nimport multerS3 from \"multer-s3\";\r\nimport { Request } from \"express\";\r\nimport { s3Client } from \"../s3/s3-client\";\r\n\r\nconsole.log(\"S3 envs:\", {\r\n  bucket: process.env.S3_BUCKET,\r\n  region: process.env.S3_REGION,\r\n  key: process.env.S3_ACCESS_KEY,\r\n  secret: process.env.S3_SECRET_KEY ? \"***\" : \"MISSING\"\r\n});\r\nif (!process.env.S3_BUCKET ||\r\n    !process.env.S3_REGION ||\r\n    !process.env.S3_ACCESS_KEY ||\r\n    !process.env.S3_SECRET_KEY ||\r\n    process.env.S3_BUCKET.trim() === \"\" ||\r\n    process.env.S3_REGION.trim() === \"\" ||\r\n    process.env.S3_ACCESS_KEY.trim() === \"\" ||\r\n    process.env.S3_SECRET_KEY.trim() === \"\") {\r\n\tthrow new Error(\"S3 environment variables are not properly configured\");\r\n}\r\n\r\nexport interface MulterS3File extends Express.Multer.File {\r\n\tlocation: string;\r\n\tkey: string;\r\n\tbucket: string;\r\n\tacl: string;\r\n\tcontentType: string;\r\n\tcontentDisposition: string | null;\r\n\tcontentEncoding: string | null;\r\n\tstorageClass: string;\r\n\tserverSideEncryption: string | null;\r\n\tmetadata: { fieldname: string };\r\n\tetag: string;\r\n\tversionId?: string;\r\n}\r\n\r\nexport interface MulterRequest extends Request {\r\n\tfiles: MulterS3File[];\r\n}\r\n\r\n/**\r\n * Create S3 storage configuration for multer\r\n */\r\nexport const createS3Storage = (userId: number, fileType?: string) => {\r\n\treturn multerS3({\r\n\t\ts3: s3Client,\r\n\t\tbucket: process.env.S3_BUCKET as string,\r\n\t\t// acl: \"public-read\",\r\n\t\tmetadata: (req, file, cb) => {\r\n\t\t\tcb(null, { fieldname: file.fieldname });\r\n\t\t},\r\n\t\tkey: (req: Request, file, cb) => {\r\n\t\t\tconsole.log(\"fileType\", req.body?.fileType, req.query?.fileType, fileType);\r\n\t\t\tconst type = fileType || (req.query?.fileType as string) || (req.body?.fileType as string);\r\n\r\n\t\t\tif (!type) {\r\n\t\t\t\tcb(new Error(\"File type is required. Must be 'note' or 'canvas'\"));\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tif (!['note', 'notes', 'canvas'].includes(type)) {\r\n\t\t\t\tcb(new Error(\"Invalid file type. Must be 'note' or 'canvas'\"));\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst timestamp = Date.now();\r\n\t\t\tconst sanitizedFileName = `${timestamp}_${file.fieldname}_${file.originalname}`;\r\n\r\n\t\t\tlet folderPath = `uploads/user/${userId}/`;\r\n\r\n\t\t\tif (type === \"notes\" || type === \"note\") {\r\n\t\t\t\tfolderPath += \"notes/image/\";\r\n\t\t\t} else if (type === \"canvas\") {\r\n\t\t\t\tfolderPath += \"canvas/image/\";\r\n\t\t\t} else {\r\n\t\t\t\tcb(new Error(\"Invalid file type. Must be 'note' or 'canvas'\"));\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tcb(null, `${folderPath}${sanitizedFileName}`);\r\n\t\t}\r\n\t});\r\n};\r\n\r\n/**\r\n * File filter function - only allows image files\r\n */\r\nexport const fileFilter = (req: Request, file: Express.Multer.File, cb: multer.FileFilterCallback) => {\r\n  // Define allowed image MIME types\r\n  const allowedMimes = [\r\n    'image/jpeg',\r\n    'image/jpg',\r\n    'image/png',\r\n    'image/gif',\r\n    'image/webp',\r\n    'image/svg+xml'\r\n  ];\r\n\r\n  // Define allowed file extensions\r\n  const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];\r\n  const fileExtension = file.originalname.toLowerCase().substring(file.originalname.lastIndexOf('.'));\r\n\r\n  // Check if MIME type is allowed\r\n  const isAllowedMimeType = allowedMimes.includes(file.mimetype);\r\n\r\n  // Check if file extension is allowed\r\n  const isAllowedExtension = allowedExtensions.includes(fileExtension);\r\n\r\n  if (isAllowedMimeType && isAllowedExtension) {\r\n    cb(null, true);\r\n  } else {\r\n    cb(new Error('Only image files (JPEG, PNG, GIF, WebP, SVG) are allowed'));\r\n  }\r\n};\r\n\r\n/**\r\n * Create multer upload middleware\r\n */\r\nexport const createUploadMiddleware = (userId: number, fileType?: string, maxFileSize = 5 * 1024 * 1024) => {\r\n\treturn multer({\r\n\t\tstorage: createS3Storage(userId, fileType),\r\n\t\tfileFilter,\r\n\t\tlimits: {\r\n\t\t\tfileSize: maxFileSize, // Default 5MB\r\n\t\t\tfiles: 1, // Only allow single file upload\r\n\t\t},\r\n\t}).single(\"file\"); // Changed from .array() to .single()\r\n};"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAAmB;AACnB,uBAAqB;AAErB,uBAAyB;AAEzB,QAAQ,IAAI,YAAY;AAAA,EACtB,QAAQ,QAAQ,IAAI;AAAA,EACpB,QAAQ,QAAQ,IAAI;AAAA,EACpB,KAAK,QAAQ,IAAI;AAAA,EACjB,QAAQ,QAAQ,IAAI,gBAAgB,QAAQ;AAC9C,CAAC;AACD,IAAI,CAAC,QAAQ,IAAI,aACb,CAAC,QAAQ,IAAI,aACb,CAAC,QAAQ,IAAI,iBACb,CAAC,QAAQ,IAAI,iBACb,QAAQ,IAAI,UAAU,KAAK,MAAM,MACjC,QAAQ,IAAI,UAAU,KAAK,MAAM,MACjC,QAAQ,IAAI,cAAc,KAAK,MAAM,MACrC,QAAQ,IAAI,cAAc,KAAK,MAAM,IAAI;AAC5C,QAAM,IAAI,MAAM,sDAAsD;AACvE;AAwBO,MAAM,kBAAkB,CAAC,QAAgB,aAAsB;AACrE,aAAO,iBAAAA,SAAS;AAAA,IACf,IAAI;AAAA,IACJ,QAAQ,QAAQ,IAAI;AAAA;AAAA,IAEpB,UAAU,CAAC,KAAK,MAAM,OAAO;AAC5B,SAAG,MAAM,EAAE,WAAW,KAAK,UAAU,CAAC;AAAA,IACvC;AAAA,IACA,KAAK,CAAC,KAAc,MAAM,OAAO;AAChC,cAAQ,IAAI,YAAY,IAAI,MAAM,UAAU,IAAI,OAAO,UAAU,QAAQ;AACzE,YAAM,OAAO,YAAa,IAAI,OAAO,YAAwB,IAAI,MAAM;AAEvE,UAAI,CAAC,MAAM;AACV,WAAG,IAAI,MAAM,mDAAmD,CAAC;AACjE;AAAA,MACD;AAEA,UAAI,CAAC,CAAC,QAAQ,SAAS,QAAQ,EAAE,SAAS,IAAI,GAAG;AAChD,WAAG,IAAI,MAAM,+CAA+C,CAAC;AAC7D;AAAA,MACD;AAEA,YAAM,YAAY,KAAK,IAAI;AAC3B,YAAM,oBAAoB,GAAG,SAAS,IAAI,KAAK,SAAS,IAAI,KAAK,YAAY;AAE7E,UAAI,aAAa,gBAAgB,MAAM;AAEvC,UAAI,SAAS,WAAW,SAAS,QAAQ;AACxC,sBAAc;AAAA,MACf,WAAW,SAAS,UAAU;AAC7B,sBAAc;AAAA,MACf,OAAO;AACN,WAAG,IAAI,MAAM,+CAA+C,CAAC;AAC7D;AAAA,MACD;AAEA,SAAG,MAAM,GAAG,UAAU,GAAG,iBAAiB,EAAE;AAAA,IAC7C;AAAA,EACD,CAAC;AACF;AAKO,MAAM,aAAa,CAAC,KAAc,MAA2B,OAAkC;AAEpG,QAAM,eAAe;AAAA,IACnB;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AAGA,QAAM,oBAAoB,CAAC,QAAQ,SAAS,QAAQ,QAAQ,SAAS,MAAM;AAC3E,QAAM,gBAAgB,KAAK,aAAa,YAAY,EAAE,UAAU,KAAK,aAAa,YAAY,GAAG,CAAC;AAGlG,QAAM,oBAAoB,aAAa,SAAS,KAAK,QAAQ;AAG7D,QAAM,qBAAqB,kBAAkB,SAAS,aAAa;AAEnE,MAAI,qBAAqB,oBAAoB;AAC3C,OAAG,MAAM,IAAI;AAAA,EACf,OAAO;AACL,OAAG,IAAI,MAAM,0DAA0D,CAAC;AAAA,EAC1E;AACF;AAKO,MAAM,yBAAyB,CAAC,QAAgB,UAAmB,cAAc,IAAI,OAAO,SAAS;AAC3G,aAAO,cAAAC,SAAO;AAAA,IACb,SAAS,gBAAgB,QAAQ,QAAQ;AAAA,IACzC;AAAA,IACA,QAAQ;AAAA,MACP,UAAU;AAAA;AAAA,MACV,OAAO;AAAA;AAAA,IACR;AAAA,EACD,CAAC,EAAE,OAAO,MAAM;AACjB;",
  "names": ["multerS3", "multer"]
}
