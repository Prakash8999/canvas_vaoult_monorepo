{
  "version": 3,
  "sources": ["../../../../../../../src/common/middlewares/auth/authMiddleware.ts"],
  "sourcesContent": ["import { NextFunction, Request, Response } from \"express\";\r\n\r\nimport jwt from \"jsonwebtoken\";\r\nimport { AuthenticatedUser } from \"../../types/authInterface\";\r\nimport { User } from \"../../../modules/users/users.model\";\r\nimport { authLogger } from \"../../utils/authLogger\";\r\nimport { errorHandler } from \"../responseHandler\";\r\nimport redisClient from \"../../../config/redis\";\r\nimport { redisKey } from \"../../utils/redisKey\";\r\n\r\n\r\n// Helper function to validate JWT secret\r\nconst validateJwtSecret = (): string => {\r\n\tconst secret = process.env.JWT_SECRET;\r\n\tif (!secret) {\r\n\t\tthrow new Error(\"JWT_SECRET environment variable is not defined\");\r\n\t}\r\n\tif (secret.length < 32) {\r\n\t\tconsole.warn(\"JWT_SECRET should be at least 32 characters long for security\");\r\n\t}\r\n\treturn secret;\r\n};\r\n\r\n// Helper function to extract token from headers\r\nconst extractToken = (req: Request): string | null => {\r\n\t// Check Authorization header first (standard)\r\n\tconst authHeader = req.header('Authorization');\r\n\tif (authHeader && authHeader.startsWith('Bearer ')) {\r\n\t\treturn authHeader.slice(7);\r\n\t}\r\n\r\n\t// Fallback to custom x-auth-token header\r\n\tconst customHeader = req.header('x-auth-token');\r\n\tif (customHeader) {\r\n\t\treturn customHeader.startsWith('Bearer ') ? customHeader.slice(7) : customHeader;\r\n\t}\r\n\r\n\treturn null;\r\n};\r\n\r\n// Helper function to get user from cache or database\r\nconst getUserById = async (userId: number): Promise<any | null> => {\r\n\r\n\r\n\ttry {\r\n\t\tconst user = await User.findOne({\r\n\t\t\twhere: {\r\n\t\t\t\tid: userId,\r\n\t\t\t\tblock: false,\r\n\t\t\t},\r\n\t\t\tattributes: ['id', 'email', 'name', 'is_email_verified', 'profile_url', 'created_at'],\r\n\t\t});\r\n\r\n\r\n\t\treturn user?.dataValues || null;\r\n\t} catch (error) {\r\n\t\tconsole.error('Database error in getUserById:', error);\r\n\t\treturn null;\r\n\t}\r\n};\r\n\r\nexport const authUser = async (req: Request, res: Response, next: NextFunction) => {\r\n\r\n\tconst rawToken = req.cookies?.refresh_token;\r\n\tif (!rawToken) {\r\n\t\terrorHandler(res, \"Authentication token not found\", {}, 401);\r\n\t\treturn;\r\n\t}\r\n\r\n\t// const tokenHash = hashToken(rawToken);\r\n\t// const now = new Date();\r\n\t// const session = await AuthToken.findOne({\r\n\t// \twhere: {\r\n\t// \t\ttoken_hash: tokenHash, revoked: false, expires_at: { [Op.gt]: now },\r\n\t// \t}\r\n\t// });\r\n\t// if (!session) {\r\n\t// \terrorHandler(res, \"Invalid authentication token\", {}, 401);\r\n\t// \treturn;\r\n\t// }\r\n\r\n\tconst xForwardedFor = req.headers['x-forwarded-for'];\r\n\tconst clientIP =\r\n\t\treq.ip ||\r\n\t\t(typeof xForwardedFor === 'string'\r\n\t\t\t? xForwardedFor.split(',')[0].trim()\r\n\t\t\t: undefined) ||\r\n\t\t'unknown';\r\n\tconst userAgent = req.get('User-Agent') || 'unknown';\r\n\r\n\ttry {\r\n\t\t// Extract token from headers\r\n\t\tconst token = extractToken(req);\r\n\t\tif (!token) {\r\n\t\t\tauthLogger.log({\r\n\t\t\t\taction: 'LOGIN_FAILED',\r\n\t\t\t\tip: clientIP,\r\n\t\t\t\tuserAgent,\r\n\t\t\t\turl: req.url,\r\n\t\t\t\tmethod: req.method,\r\n\t\t\t\terror: 'No token provided'\r\n\t\t\t});\r\n\t\t\terrorHandler(res, \"Authentication token not found\", {}, 401);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconsole.log('Extracted Token:', token);\r\n\r\n\t\t// Validate token format (basic check)\r\n\t\tif (token.length < 10) {\r\n\t\t\tauthLogger.log({\r\n\t\t\t\taction: 'TOKEN_INVALID',\r\n\t\t\t\tip: clientIP,\r\n\t\t\t\tuserAgent,\r\n\t\t\t\turl: req.url,\r\n\t\t\t\tmethod: req.method,\r\n\t\t\t\terror: 'Invalid token format'\r\n\t\t\t});\r\n\t\t\terrorHandler(res, \"Invalid token format\", {}, 401);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Verify JWT token\r\n\t\tlet decoded: AuthenticatedUser;\r\n\t\ttry {\r\n\t\t\tconst jwtSecret = validateJwtSecret();\r\n\t\t\tconsole.log('Validating token...', jwtSecret);\r\n\t\t\tdecoded = jwt.verify(token, jwtSecret, {\r\n\t\t\t\tissuer: 'canvas-backend',\r\n\t\t\t\taudience: 'canvas-users',\r\n\t\t\t\t// Add clock tolerance for minor time differences\r\n\t\t\t\tclockTolerance: 30, // 30 seconds\r\n\t\t\t}) as AuthenticatedUser;\r\n\t\t} catch (error: any) {\r\n\t\t\tconsole.error('JWT verification error:', error);\r\n\t\t\t// Enhanced error handling with more specific messages\r\n\t\t\tconst action = error.name === 'TokenExpiredError' ? 'TOKEN_EXPIRED' : 'TOKEN_INVALID';\r\n\t\t\tauthLogger.log({\r\n\t\t\t\taction,\r\n\t\t\t\tip: clientIP,\r\n\t\t\t\tuserAgent,\r\n\t\t\t\turl: req.url,\r\n\t\t\t\tmethod: req.method,\r\n\t\t\t\terror: error.message\r\n\t\t\t});\r\n\r\n\t\t\tswitch (error.name) {\r\n\t\t\t\tcase 'TokenExpiredError':\r\n\t\t\t\t\terrorHandler(res, \"Token has expired. Please login again\", {}, 401);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'JsonWebTokenError':\r\n\t\t\t\t\terrorHandler(res, \"Invalid token signature\", {}, 401);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'NotBeforeError':\r\n\t\t\t\t\terrorHandler(res, \"Token not active yet\", {}, 401);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tconsole.error('JWT verification error:', error);\r\n\t\t\t\t\terrorHandler(res, \"Token verification failed\", {}, 401);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Validate decoded token structure\r\n\t\tif (!decoded.userId || !decoded.email) {\r\n\t\t\tauthLogger.log({\r\n\t\t\t\taction: 'TOKEN_INVALID',\r\n\t\t\t\tip: clientIP,\r\n\t\t\t\tuserAgent,\r\n\t\t\t\turl: req.url,\r\n\t\t\t\tmethod: req.method,\r\n\t\t\t\terror: 'Invalid token payload'\r\n\t\t\t});\r\n\t\t\terrorHandler(res, \"Invalid token payload\", {}, 401);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\r\n\r\n\r\n\t\tconst key = redisKey(\"session\", decoded.userId, decoded.deviceId, decoded.jti);\r\n\t\tconst tokenExists = await redisClient.get(key);\r\n\r\n\t\tif (!tokenExists) {\r\n\t\t\terrorHandler(res, \"Access token invalid or revoked\", {}, 401);\r\n\r\n\t\t\treturn\r\n\t\t}\r\n\t\t// Get user from database with caching\r\n\t\tconst userData = await getUserById(decoded.userId);\r\n\t\tif (!userData) {\r\n\t\t\tauthLogger.log({\r\n\t\t\t\taction: 'USER_NOT_FOUND',\r\n\t\t\t\tuserId: decoded.userId.toString(),\r\n\t\t\t\temail: decoded.email,\r\n\t\t\t\tip: clientIP,\r\n\t\t\t\tuserAgent,\r\n\t\t\t\turl: req.url,\r\n\t\t\t\tmethod: req.method,\r\n\t\t\t\terror: 'User not found or disabled'\r\n\t\t\t});\r\n\t\t\terrorHandler(res, \"User not found or has been disabled\", {}, 401);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Additional security check: verify email matches\r\n\t\tif (userData.email !== decoded.email) {\r\n\t\t\tauthLogger.log({\r\n\t\t\t\taction: 'TOKEN_INVALID',\r\n\t\t\t\tuserId: decoded.userId.toString(),\r\n\t\t\t\temail: decoded.email,\r\n\t\t\t\tip: clientIP,\r\n\t\t\t\tuserAgent,\r\n\t\t\t\turl: req.url,\r\n\t\t\t\tmethod: req.method,\r\n\t\t\t\terror: `Email mismatch: token=${decoded.email}, db=${userData.email}`\r\n\t\t\t});\r\n\t\t\terrorHandler(res, \"Token validation failed\", {}, 401);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// Attach user data to request object\r\n\t\treq.user = {\r\n\t\t\tuserId: decoded.userId,\r\n\t\t\temail: decoded.email,\r\n\t\t\tisEmailVerified: userData.is_email_verified,\r\n\t\t\tname: userData.name,\r\n\t\t\tdeviceId: decoded.deviceId,\r\n\t\t\tjti: decoded.jti,\r\n\t\t\tprofileUrl: userData.profile_url,\r\n\t\t\tiat: decoded.iat,\r\n\t\t\texp: decoded.exp,\r\n\t\t};\r\n\r\n\t\t// Log successful authentication\r\n\t\tauthLogger.log({\r\n\t\t\taction: 'LOGIN_SUCCESS',\r\n\t\t\tuserId: decoded.userId.toString(),\r\n\t\t\temail: decoded.email,\r\n\t\t\tip: clientIP,\r\n\t\t\tuserAgent,\r\n\t\t\turl: req.url,\r\n\t\t\tmethod: req.method\r\n\t\t});\r\n\r\n\t\tnext();\r\n\t} catch (error: any) {\r\n\t\t// Log error for debugging but don't expose internal details\r\n\t\tauthLogger.log({\r\n\t\t\taction: 'AUTH_ERROR',\r\n\t\t\tuserId: req.user?.userId.toString(),\r\n\t\t\tip: clientIP,\r\n\t\t\tuserAgent,\r\n\t\t\turl: req.url,\r\n\t\t\tmethod: req.method,\r\n\t\t\terror: error.message\r\n\t\t});\r\n\r\n\t\tconsole.error('Auth middleware error:', {\r\n\t\t\terror: error.message,\r\n\t\t\tstack: error.stack,\r\n\t\t\tuserId: req.user?.userId,\r\n\t\t\turl: req.url,\r\n\t\t\tmethod: req.method,\r\n\t\t});\r\n\r\n\t\terrorHandler(res, \"Authentication failed\", {}, 500);\r\n\t\treturn;\r\n\t}\r\n};\r\n\r\n"],
  "mappings": "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",
  "names": ["jwt", "redisClient"]
}
